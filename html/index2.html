<!--
  <head>
  <meta charset="UTF-8">
  <title>Random Character Grid</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    td {
      border: 1px solid black;
      padding: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="gameTable"></div>

  <script>
    var serverUrl = "ws://" + window.location.hostname + ":9880";
    var connection = new WebSocket(serverUrl);

    connection.onmessage = function(evt) {
      console.log("Message received: ", evt.data);
      var data = JSON.parse(evt.data);
      
      if(data.wordBank && data.wordBank.grid) { // Make sure to properly check for the nested property
        updateGrid(data.wordBank.grid);
      }
    };

    function updateGrid(grid) {
      var table = document.createElement('table');
      grid.forEach(function(row, rowIndex) {
        var tr = document.createElement('tr');
        row.forEach(function(column, columnIndex) {
          var td = document.createElement('td');
          var button = document.createElement('button');
          button.textContent = column;
          // Set up an onclick function that calls buttonclick with parameters
          button.onclick = function() {
            //buttonclick(rowIndex, columnIndex); // Assuming you want to pass row and column indexes
          };
          td.appendChild(button);
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      var container = document.getElementById('gameTable');
      container.innerHTML = ''; // Clear previous table
      container.appendChild(table);
    }
  </script>
-->


<head>
  <meta charset="utf-8">
</head>

<label id="topMessage"></label>

<body>
  <div id="gameTable"></div>

  <div id="chatbox">
    <div id="messages" style="height: 200px; overflow-y: scroll; background: #f1f1f1; margin-bottom: 10px;"></div>
    <input type="text" id="message" placeholder="Type message here..." style="width: 70%;" onkeypress="if(event.keyCode==13) chat();">
    <button onclick="chat();">Send</button>
  </div>

  <script>
    var idx = -1;
    var gameid = -1;
    class UserEvent {
      Button = -1;
      GridRow = -1;
      GridColumn = -1;
      PlayerIdx = 0;
      GameId = 0;
      Msg = null;
    }
    var connection = null;

    var serverUrl;
    serverUrl = "ws://" + window.location.hostname + ":9880";
    // Create the connection with the server
    connection = new WebSocket(serverUrl);

    connection.onopen = function (evt) {
      console.log("open");
    }
    connection.onclose = function (evt) {
      console.log("close");
      document.getElementById("topMessage").innerHTML = "Server Offline"
    }
    const ButtonStateToDisplay = new Map();
    ButtonStateToDisplay.set("XPLAYER", "X");
    ButtonStateToDisplay.set("OPLAYER", "O");
    ButtonStateToDisplay.set("NOPLAYER", " ");

    connection.onmessage = function (evt) {
      var msg;
      msg = evt.data;

      console.log("Message received: " + msg);
      const obj = JSON.parse(msg);

      if ('YouAre' in obj) {
        if (obj.YouAre == "XPLAYER") {
          idx = 0;
        }
        else {
          idx = 1;
        }

        gameid = obj.GameId;
      }
      else
      {
        if(gameid == obj.GameId && obj.playersJoined < 3)
        {
          generateGrid(obj.wordBank.grid);
        }
        else
        {
          if(gameid == obj.GameId)
          {
            updateGrid(obj.pickedLetters);
          }

          if (obj.chatBox.messageSent == true && gameid == obj.GameId) {
            var messages = obj.chatBox.messages;
            var lastMessage = messages[messages.length - 1]; // Get the last message from the messages array
            var messagesDiv = document.getElementById('messages');
            var messageElement = document.createElement('div');
            messageElement.textContent = lastMessage; // Display the last message
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto scroll to the bottom
          }//ERROR typing in chat before two players in game messes it up
          else if ('CurrentTurn' in obj) {
            // only pay attention to this game
            if (gameid == obj.GameId) {
              document.getElementById("topMessage").innerHTML = obj.Msg[idx];
            }
          }
        }        
      }
    }

    function chat() {
      U = new UserEvent();
      U.Button = 9;
      if (idx == 0)
        U.PlayerIdx = "XPLAYER";
      else
        U.PlayerIdx = "OPLAYER";
      U.GameId = gameid;

      var inputElement = document.getElementById('message');
      var inputValue = inputElement.value;
      U.Msg = inputValue;
      document.getElementById('message').value = null;
      console.log("test 2");

      connection.send(JSON.stringify(U));
      console.log(JSON.stringify(U));
    }  // Existing game UI update logic here

    function generateGrid(grid) {
      var table = document.createElement('table');
      grid.forEach(function(row, rowIndex) {
        var tr = document.createElement('tr');
        row.forEach(function(column, columnIndex) {
          var td = document.createElement('td');
          var button = document.createElement('button');
          button.textContent = column;
          // Set up an onclick function that calls buttonclick with parameters
          button.onclick = function() {
            buttonclick(rowIndex, columnIndex); // Assuming you want to pass row and column indexes
          };
          td.appendChild(button);
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      var container = document.getElementById('gameTable');
      container.innerHTML = ''; // Clear previous table
      container.appendChild(table);
    }

    function updateGrid(letters) {
      letters.forEach(function (letter) {
        var buttonElement = document.querySelector('table tr:nth-child(' + (letter.row + 1) + ') td:nth-child(' + (letter.col + 1) + ') button');
        if (letter.playerId == 'XPLAYER') {
          buttonElement.style.backgroundColor = 'yellow';
        } else if (letter.playerId == 'OPLAYER') {
          buttonElement.style.backgroundColor = 'green';
        }
      });
    }



    function buttonclick(i, j) {
      U = new UserEvent();
      U.GridRow = i;
      U.GridColumn = j;
      if (idx == 0)
        U.PlayerIdx = "XPLAYER";
      else
        U.PlayerIdx = "OPLAYER";
      U.GameId = gameid;

      var buttonElement = document.querySelector('table tr:nth-child(' + (i + 1) + ') td:nth-child(' + (j + 1) + ') button');

      if(U.PlayerIdx == 'XPLAYER'){
        buttonElement.style.backgroundColor = 'yellow';
      }
      else if(U.PlayerIdx == 'OPLAYER'){
        buttonElement.style.backgroundColor = 'green';
      }


      connection.send(JSON.stringify(U));
      console.log(JSON.stringify(U));
    }
  </script>
