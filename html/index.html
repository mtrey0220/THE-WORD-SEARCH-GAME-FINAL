<head>
  <meta charset="utf-8">
  <style>
    #gameTable {
      float: left;
      width: 65%;
    }
    #sidePanels {
      position: absolute;
      right: 20px;
      top: 20px;
      width: 30%;
      display: flex;
      flex-direction: column;
    }
    #scoreBoard, #wordList {
      border: 1px solid black;
      padding: 10px;
      margin-bottom: 10px;
    }
    #wordList {
      overflow-y: auto;
      flex-grow: 1;
    }
    #chatbox {
      clear: both;
    }
  </style>
</head>


<label id="topMessage"></label>

<body>
  <div id="gameTable"></div>
  <div id="sidePanels" style="position: absolute; right: 20px; top: 20px; width: 30%;">
    <div id="scoreBoard" style="border: 1px solid black; padding: 10px; margin-bottom: 10px;"></div>
    <div id="wordList" style="border: 1px solid black; padding: 10px; overflow-y: auto; max-height: 300px;"></div>
  </div>


  <div id="chatbox">
    <div id="messages" style="height: 200px; overflow-y: scroll; background: #f1f1f1; margin-bottom: 10px;"></div>
    <input type="text" id="message" placeholder="Type message here..." style="width: 70%;" onkeypress="if(event.keyCode==13) chat();">
    <button onclick="chat();">Send</button>
  </div>


  <script>
    var idx = -1;
    var gameid = -1;
    class UserEvent {
      Button = -1;
      GridRow = -1;
      GridColumn = -1;
      PlayerIdx = 0;
      GameId = 0;
      Msg = null;
    }
    var connection = null;

    let start = [-1, -1];
    let end = [-1, -1];

    var serverUrl;
    serverUrl = "ws://" + window.location.hostname + ":9880";
    // Create the connection with the server
    connection = new WebSocket(serverUrl);

    connection.onopen = function (evt) {
      console.log("open");
    }
    connection.onclose = function (evt) {
      console.log("close");
      document.getElementById("topMessage").innerHTML = "Server Offline"
    }
    const ButtonStateToDisplay = new Map();
    ButtonStateToDisplay.set("XPLAYER", "X");
    ButtonStateToDisplay.set("OPLAYER", "O");
    //Craeted By Abubakar Kassim
    ButtonStateToDisplay.set("PLAYER3", "3");
    ButtonStateToDisplay.set("4PLAYER", "4");

    ButtonStateToDisplay.set("NOPLAYER", " ");

    connection.onmessage = function (evt) {
      var msg;
      msg = evt.data;

      console.log("Message received: " + msg);
      const obj = JSON.parse(msg);

      if ('YouAre' in obj) {
        if (obj.YouAre == "XPLAYER") 
        {
          idx = 0;
        }
        else if (obj.YouAre == "OPLAYER") 
        {
          idx = 1;
        }
        else if (obj.YouAre == "PLAYER3") 
        {
          idx = 2;
        }
        else if (obj.YouAre == "PLAYER4") 
        {
          idx = 3;
        }
        gameid = obj.GameId;
      }
      else
      {
        if(gameid == obj.GameId && obj.playersJoined < 3)
        {
          generateGrid(obj.wordBank.grid);
          generateScoreboard(obj.scoreBoard.scores);
          displayWords(obj.wordBank.wordsPlaced);
        }
        else
        {
          if(gameid == obj.GameId)
          {
            updateGrid(obj.pickedLetters);
            updateScoreboard(obj.scoreBoard.scores);
          }

          if (obj.chatBox.messageSent == true && gameid == obj.GameId) {
            var messages = obj.chatBox.messages;
            var lastMessage = messages[messages.length - 1]; // Get the last message from the messages array
            var messagesDiv = document.getElementById('messages');
            var messageElement = document.createElement('div');
            messageElement.textContent = lastMessage; // Display the last message
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto scroll to the bottom
          }//ERROR typing in chat before two players in game messes it up
          else if ('CurrentTurn' in obj) {
            // only pay attention to this game
            if (gameid == obj.GameId) {
              document.getElementById("topMessage").innerHTML = obj.Msg[idx];
            }
          }
        }        
      }
    }

    function chat() {
      U = new UserEvent();
      U.Button = 9;
      if (idx == 0)
        U.PlayerIdx = "XPLAYER";
      else if (idx == 1)
        U.PlayerIdx = "OPLAYER";
      else if (idx == 2)
        U.PlayerIdx = "PLAYER3";
      else if (idx == 3)
        U.PlayerIdx = "PLAYER4";
      U.GameId = gameid;

      var inputElement = document.getElementById('message');
      var inputValue = inputElement.value;
      U.Msg = inputValue;
      document.getElementById('message').value = null;
      console.log("test 2");

      connection.send(JSON.stringify(U));
      console.log(JSON.stringify(U));
    }  // Existing game UI update logic here

    function generateGrid(grid) {
      var table = document.createElement('table');
      grid.forEach(function(row, rowIndex) {
        var tr = document.createElement('tr');
        row.forEach(function(column, columnIndex) {
          var td = document.createElement('td');
          var button = document.createElement('button');
          button.textContent = column;
          // Set up an onclick function that calls buttonclick with parameters
          button.onclick = function() {
            buttonclick(rowIndex, columnIndex); // Assuming you want to pass row and column indexes
          };
          td.appendChild(button);
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      var container = document.getElementById('gameTable');
      container.innerHTML = ''; // Clear previous table
      container.appendChild(table);
    }

    function updateGrid(letters) {
      if(start[0] != -1 && end[0] != -1)
      {
        var buttonElementStart = document.querySelector('table tr:nth-child(' + (start[0] + 1) + ') td:nth-child(' + (start[1] + 1) + ') button');
        var buttonElementEnd = document.querySelector('table tr:nth-child(' + (end[0] + 1) + ') td:nth-child(' + (end[1] + 1) + ') button');
        buttonElementStart.style.backgroundColor = '';
        buttonElementEnd.style.backgroundColor = '';
        start = [-1, -1];
        end = [-1, -1];
      }
      letters.forEach(function (letter) {
        var buttonElement = document.querySelector('table tr:nth-child(' + (letter.row + 1) + ') td:nth-child(' + (letter.col + 1) + ') button');
        if (letter.playerId == 'XPLAYER') {
          buttonElement.style.backgroundColor = 'yellow';
        } else if (letter.playerId == 'OPLAYER') {
          buttonElement.style.backgroundColor = 'green';
        } else if (letter.playerId == 'PLAYER3') {
          buttonElement.style.backgroundColor = 'red';
        } else if (letter.playerId == 'PLAYER4') {
          buttonElement.style.backgroundColor == 'blue';
        }
      });
    }

    function generateScoreboard(scores) {
      var scoreboard = document.getElementById('scoreBoard');
      scoreboard.innerHTML = ''; // Clear previous scores
      scores.forEach(function(score, index) {
        var p = document.createElement('p');
        p.textContent = "Player " + (index + 1) + ": 0";
        scoreboard.appendChild(p);
      });
    }

    function updateScoreboard(scores) {
      var scoreboard = document.getElementById('scoreBoard');
    scoreboard.innerHTML = ''; // Clear existing scores
    scores.forEach(function(score, index) {
      var p = document.createElement('p');
      p.textContent = "Player " + (index + 1) + ": " + score;
      scoreboard.appendChild(p);
    });
  }

  function displayWords(words) {
    var listContainer = document.getElementById('wordList');
  listContainer.innerHTML = ''; // Clear existing words
  var ul = document.createElement('ul');
  words.forEach(function(word) {
    var li = document.createElement('li');
    li.textContent = word;
    ul.appendChild(li);
  });
  listContainer.appendChild(ul);
}


function buttonclick(i, j) {
  U = new UserEvent();
  U.GridRow = i;
  U.GridColumn = j;
  if (idx == 0)
    U.PlayerIdx = "XPLAYER";
  else if (idx == 1)
    U.PlayerIdx = "OPLAYER";
  else if (idx == 2)
    U.PlayerIdx = "PLAYER3";
  else if (idx == 3)
    U.PlayerIdx = "PLAYER4";
  else
    alert("Too many players in the game");
  U.GameId = gameid;

  if(start[0] == -1)
  {
    var buttonElement = document.querySelector('table tr:nth-child(' + (i + 1) + ') td:nth-child(' + (j + 1) + ') button');

    if(U.PlayerIdx == 'XPLAYER'){
      buttonElement.style.backgroundColor = 'yellow';
    }
    else if(U.PlayerIdx == 'OPLAYER'){
      buttonElement.style.backgroundColor = 'green';
    }
    //Created by Abubakar Kassim
    else if (U.PlayerIdx == 'PLAYER3')
    {
      alert
      buttonElement.style.backgroundColor = 'red';
    }
    else if (U.PlayerIdx == 'PLAYER4')
    {
      buttonElement.style.backgroundColor = 'blue';
    }
    else
    {
      alert("TOO MANY PLAYERS HAVE JOINED");
    }
    start[0] = i;
    start[1] = j;
  }
  else if(end[0] == -1)
  {
    var buttonElement = document.querySelector('table tr:nth-child(' + (i + 1) + ') td:nth-child(' + (j + 1) + ') button');

    if(U.PlayerIdx == 'XPLAYER'){
      buttonElement.style.backgroundColor = 'yellow';
    }
    else if(U.PlayerIdx == 'OPLAYER')
    {
      buttonElement.style.backgroundColor = 'green';
    }
    //Created By Abubakar Kassim
    else if (U.PlayerIdx == 'PLAYER3')
    {
      buttonElement.style.backgroundColor = 'red';
    }
    else if (U.PlayerIdx == 'PLAYER4')
    {
      alert("4 Players have have joined");
      buttonElement.style.backgroundColor = 'blue';
    }

    end[0] = i;
    end[1] = j;
  }
  


  connection.send(JSON.stringify(U));
  console.log(JSON.stringify(U));
}
</script>
